<%- include('./header', {}) %>

<title><%= __('index.head.title') %></title>
<script>
var user_name = null;
<%
if( user ){
  if( user.role == 0 ){
%>
window.location.href = '/admin';
<%
  }else{
%>
user_name = '<%= user.name %>';
<%
  }
}
%>
$(function(){
  if( user_name != null ){
    //. ログインしている
    $('#navbar').html( '<li><a href="#" title="Logout" onClick="logout()"><span class="glyphicon glyphicon-user"></span> ' + user_name + '(Logout)</a></li>' );
  }else{
    //. ログインしていない
    $('#navbar').html( '<li><a href="#" onClick="login()"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>' );
  }

  document.getElementById( 'file' ).addEventListener( 'change', handleFileSelect, false );


  $('#form').submit( function( event ){
    event.preventDefault();

    var form = $('#form').get()[0];
    var fd = new FormData( form );
    $.ajax({
      type: 'POST',
      url: './item',
      data: fd,
      processData: false,
      contentType: false,
      dataType: 'json',
      success: function( data ){
        data = JSON.parse( data );
        //console.log( data );
        if( data ){
          if( data.status ){
            alert( data.result );
          }else{
            alert( data.error );
          }
        }else{
          alert( 'error: POST /item' );
        }
      },
      error: function(){
        console.log( 'error' );
      }
    });

    return false;
  });
});

function handleFileSelect( evt ){
  $('#file_name').val( '' );
  $('#file_modified').val( '' );

  var files = evt.target.files;
  for( var i = 0; i < files.length; i ++ ){
    var file = files[i];
    //console.log( 'i = ' + i );
    //console.log( file );

    $('#file_name').val( file.name );
    $('#file_modified').val( file.lastModified );
  }
}

function logout(){
  if( window.confirm( 'Logout?' ) ){
    var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
    $.ajax({
      type: 'POST',
      url: '/logout',
      data: {},
      success: function( data ){
        obj.remove();
        window.location.href = '/';
      },
      error: function(){
        obj.remove();
        window.location.href = '/';
      }
    });
  }
}

function login(){
  window.location.href = '/login';
}
</script>
</head>
<body>

<div class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <a href="/" class="navbar-brand">R2B</a>
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="collapse navbar-collapse target">
      <ul class="nav navbar-nav navbar-right" id="navbar">
      </ul>
    </div>
  </div>
</div>

<div class="container">
  <form method="POST" id="form" action="./item" enctype="multipart/form-data">
    <div class="form-group">
      <input type="file" id="file" class="form-control" name="data"/>
    </div>
    <input type="hidden" id="file_name" name="file_name" value=""/>
    <input type="hidden" id="file_modified" name="file_modified" value=""/>
    <input type="submit" value="Upload" class="btn btn-info"/>
  </form>
</div>

<%- include('./footer', {}) %>
