<%- include('./header', {}) %>

<title><%= __('index.head.title') %></title>
<script>
var user_name = null;
<%
if( user ){
  if( user.role == 0 ){
%>
window.location.href = '/admin';
<%
  }else{
%>
user_name = '<%= user.name %>';
<%
  }
}
%>
$(function(){
  if( user_name != null ){
    //. ログインしている
    $('#navbar').html( '<li><a href="#" title="Logout" onClick="logout()"><span class="glyphicon glyphicon-user"></span> ' + user_name + '(Logout)</a></li>' );
  }else{
    //. ログインしていない
    $('#navbar').html( '<li><a href="#" onClick="login()"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>' );
  }

  document.getElementById( 'file' ).addEventListener( 'change', handleFileSelect, false );


  $('#form').submit( function( event ){
    event.preventDefault();

    var form = $('#form').get()[0];
    var fd = new FormData( form );
    $.ajax({
      type: 'POST',
      url: './item',
      data: fd,
      processData: false,
      contentType: false,
      dataType: 'json',
      success: function( data ){
        data = JSON.parse( data );
        //console.log( data );
        if( data ){
          if( data.status ){
            alert( data.result );
          }else{
            alert( data.error );
          }
        }else{
          alert( 'error: POST /item' );
        }
      },
      error: function(){
        console.log( 'error' );
      }
    });

    return false;
  });

<%
if( user ){
%>
  getItems();
<%
}
%>
});

function getItems(){
  $('#items_table_tbody').html( '' );
  var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
  $.ajax({
    type: 'GET',
    url: '/items',
    success: function( result ){
      obj.remove();
      console.log( result );
      var items = result.result;
      items.forEach( item => {
        var owner_id = '';
        var n = item.owner.indexOf( '#' );
        if( n > -1 ){
          owner_id = item.owner.substring( n + 1, item.owner.length - 1 );
        }

        console.log( item );

        var tr = "<tr><td>" + item.id.substring( 0, 10 )
          + "..</td><td>" + item.rev
          + "</td><td>" + item.name
          + "</td><td>" + item.hash.substring( 0, 10 )
          + "..</td><td>" + owner_id
          + "</td><td>" + item.modified
          + "</td><td>" + item.datetime
          + "</td><td>" + item.datetime
          + "</td><td><input type='button' class='btn btn-default' value='<%= __('items.buttonlabel.delete') %>' onClick='deleteItem(\"" + item.id + "\")'/>"
          + "</td></tr>";
        $('#items_table_tbody').append( tr );
      });
    },
    error: function( err ){
      obj.remove();
      console.log( err );
    }
  });
}

function deleteItem(id){
  if( window.confirm( '<%= __('items.confirm.delete') %>' + id + ' ?' ) ){
    $.ajax({
      type: 'DELETE',
      url: '/item',
      data: { id: id },
      success: function( data ){
        window.location.href = '/';
      },
      error: function(){
        window.location.href = '/';
      }
    });
  }
}

function handleFileSelect( evt ){
  $('#file_name').val( '' );
  $('#file_modified').val( '' );

  var files = evt.target.files;
  for( var i = 0; i < files.length; i ++ ){
    var file = files[i];
    //console.log( 'i = ' + i );
    //console.log( file );

    $('#file_name').val( file.name );
    $('#file_modified').val( file.lastModified );
  }
}

function logout(){
  if( window.confirm( 'Logout?' ) ){
    var obj = getBusyOverlay( 'viewport', {color:'black', opacity:0.5, text:'loading', style:'text-decoration:blink; font-weight:bold; font-size:12px; color:white;' } );
    $.ajax({
      type: 'POST',
      url: '/logout',
      data: {},
      success: function( data ){
        obj.remove();
        window.location.href = '/';
      },
      error: function(){
        obj.remove();
        window.location.href = '/';
      }
    });
  }
}

function login(){
  window.location.href = '/login';
}
</script>
</head>
<body>

<div class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <a href="/" class="navbar-brand">R2B</a>
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="collapse navbar-collapse target">
      <ul class="nav navbar-nav navbar-right" id="navbar">
      </ul>
    </div>
  </div>
</div>

<div class="container">
  <form method="POST" id="form" action="./item" enctype="multipart/form-data">
    <div class="form-group">
      <input type="file" id="file" class="form-control" name="data"/>
    </div>
    <input type="hidden" id="file_name" name="file_name" value=""/>
    <input type="hidden" id="file_modified" name="file_modified" value=""/>
    <input type="submit" value="Upload" class="btn btn-info"/>
  </form>
</div>

<%
if( user ){
%>
<div class="container-fluid" style="padding:20px 0; font-size:8px;">
  <table class="table table-hover table-bordered" id="items_table">
    <thead class="table-inverse">
      <tr>
        <tr><th bgcolor="#ddddff" colspan="8"</th></tr>
        <th><%= __('items.table.id') %></th>
        <th><%= __('items.table.rev') %></th>
        <th><%= __('items.table.name') %></th>
        <th><%= __('items.table.hash') %></th>
        <th><%= __('items.table.owner') %></th>
        <th><%= __('items.table.modified') %></th>
        <th><%= __('items.table.datetime') %></th>
        <th><%= __('items.table.action') %></th>
      </tr>
    </thead>
    <tbody id="items_table_tbody">
    </tbody>
  </table>
</div>
<%
}
%>

<%- include('./footer', {}) %>
